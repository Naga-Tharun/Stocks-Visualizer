using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Stocks_Visualizer.Server.Models.Domain;
using Stocks_Visualizer.Server.Models.DTO;
using Stocks_Visualizer.Server.Repositories.Interface;
using System.Net.Http;
using System.Reflection.Metadata.Ecma335;

namespace Stocks_Visualizer.Server.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class StocksController : ControllerBase
    {
        private readonly IStockRepository stockRepository;

        private readonly IHttpClientFactory httpClientFactory;

        public StocksController(IStockRepository stockRepository, IHttpClientFactory httpClientFactory)
        {
            this.stockRepository = stockRepository;
            this.httpClientFactory = httpClientFactory;
        }

        // 
        [HttpPost]
        public async Task<IActionResult> AddStock([FromBody] AddStockRequestDto request)
        {

            try
            {
                var apiUrl = "";

                if (request.TimeFrame == "intraday")
                {
                    if (request.Interval == "")
                    {
                        return BadRequest("Interval is required for intraday time frame");
                    }

                    apiUrl = $"https://www.alphavantage.co/query?function=TIME_SERIES_{request.TimeFrame}&symbol={request.Symbol}&interval={request.Interval}&apikey=2XUP1DI8XMATRETW";
                }
                else
                {
                    apiUrl = $"https://www.alphavantage.co/query?function=TIME_SERIES_{request.TimeFrame}&symbol={request.Symbol}&apikey=2XUP1DI8XMATRETW";
                }


                using (var httpClient = httpClientFactory.CreateClient())
                {
                    var ApiResponse = await httpClient.GetStringAsync(apiUrl);

                    // Deserialize the JSON response from Alpha Vantage
                    // var alphaVantageResponse = JsonConvert.DeserializeObject<AlphaVantageResponseDto>(response);

                    // Now you have the data in alphaVantageResponse.TimeSeries
                    // You can transform and store it in your database here
                    // For example, you can use your DbContext to save the data

                    //var avResponse = JsonConvert.DeserializeObject(response);
                    
                    //var timeSeries = JsonConvert.DeserializeObject<Dictionary<string, Dictionary<string, string>>>((string)avResponse);

                    if (request.TimeFrame == "intraday")
                    {
                        // testing string
                        ApiResponse = "{\r\n    \"Meta Data\": {\r\n        \"1. Information\": \"Intraday (5min) open, high, low, close prices and volume\",\r\n        \"2. Symbol\": \"IBM\",\r\n        \"3. Last Refreshed\": \"2024-03-04 19:55:00\",\r\n        \"4. Interval\": \"5min\",\r\n        \"5. Output Size\": \"Compact\",\r\n        \"6. Time Zone\": \"US/Eastern\"\r\n    },\r\n    \"Time Series (5min)\": {\r\n        \"2024-03-04 19:55:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"193.0000\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"54\"\r\n        },\r\n        \"2024-03-04 19:50:00\": {\r\n            \"1. open\": \"192.9000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.9000\",\r\n            \"4. close\": \"192.9000\",\r\n            \"5. volume\": \"90\"\r\n        },\r\n        \"2024-03-04 19:45:00\": {\r\n            \"1. open\": \"192.7300\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.7300\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"29\"\r\n        },\r\n        \"2024-03-04 19:40:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"192.9900\",\r\n            \"3. low\": \"192.8000\",\r\n            \"4. close\": \"192.9000\",\r\n            \"5. volume\": \"36\"\r\n        },\r\n        \"2024-03-04 19:35:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"192.8000\",\r\n            \"3. low\": \"192.1000\",\r\n            \"4. close\": \"192.1000\",\r\n            \"5. volume\": \"19\"\r\n        },\r\n        \"2024-03-04 19:30:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"192.8000\",\r\n            \"3. low\": \"192.8000\",\r\n            \"4. close\": \"192.8000\",\r\n            \"5. volume\": \"145\"\r\n        },\r\n        \"2024-03-04 19:25:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.7600\",\r\n            \"5. volume\": \"140\"\r\n        },\r\n        \"2024-03-04 19:20:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"192.8000\",\r\n            \"3. low\": \"192.7600\",\r\n            \"4. close\": \"192.7600\",\r\n            \"5. volume\": \"11\"\r\n        },\r\n        \"2024-03-04 19:15:00\": {\r\n            \"1. open\": \"192.9000\",\r\n            \"2. high\": \"192.9000\",\r\n            \"3. low\": \"192.7900\",\r\n            \"4. close\": \"192.8000\",\r\n            \"5. volume\": \"167\"\r\n        },\r\n        \"2024-03-04 19:10:00\": {\r\n            \"1. open\": \"192.7500\",\r\n            \"2. high\": \"192.7520\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.7520\",\r\n            \"5. volume\": \"25\"\r\n        },\r\n        \"2024-03-04 19:05:00\": {\r\n            \"1. open\": \"192.8300\",\r\n            \"2. high\": \"192.8800\",\r\n            \"3. low\": \"192.7900\",\r\n            \"4. close\": \"192.8800\",\r\n            \"5. volume\": \"123\"\r\n        },\r\n        \"2024-03-04 19:00:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.0600\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"827445\"\r\n        },\r\n        \"2024-03-04 18:55:00\": {\r\n            \"1. open\": \"192.8300\",\r\n            \"2. high\": \"192.9600\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.9600\",\r\n            \"5. volume\": \"107\"\r\n        },\r\n        \"2024-03-04 18:50:00\": {\r\n            \"1. open\": \"192.8600\",\r\n            \"2. high\": \"192.8600\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"15\"\r\n        },\r\n        \"2024-03-04 18:40:00\": {\r\n            \"1. open\": \"192.8900\",\r\n            \"2. high\": \"192.8900\",\r\n            \"3. low\": \"192.8900\",\r\n            \"4. close\": \"192.8900\",\r\n            \"5. volume\": \"1\"\r\n        },\r\n        \"2024-03-04 18:30:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.0600\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"827264\"\r\n        },\r\n        \"2024-03-04 18:25:00\": {\r\n            \"1. open\": \"192.9000\",\r\n            \"2. high\": \"192.9000\",\r\n            \"3. low\": \"192.8900\",\r\n            \"4. close\": \"192.8900\",\r\n            \"5. volume\": \"2\"\r\n        },\r\n        \"2024-03-04 18:15:00\": {\r\n            \"1. open\": \"192.8900\",\r\n            \"2. high\": \"192.8900\",\r\n            \"3. low\": \"192.8900\",\r\n            \"4. close\": \"192.8900\",\r\n            \"5. volume\": \"1\"\r\n        },\r\n        \"2024-03-04 18:10:00\": {\r\n            \"1. open\": \"192.8300\",\r\n            \"2. high\": \"192.9100\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"295\"\r\n        },\r\n        \"2024-03-04 18:05:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.9100\",\r\n            \"4. close\": \"192.9100\",\r\n            \"5. volume\": \"64\"\r\n        },\r\n        \"2024-03-04 18:00:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.9000\",\r\n            \"5. volume\": \"215\"\r\n        },\r\n        \"2024-03-04 17:55:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"193.0000\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"77\"\r\n        },\r\n        \"2024-03-04 17:50:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"443\"\r\n        },\r\n        \"2024-03-04 17:45:00\": {\r\n            \"1. open\": \"192.9000\",\r\n            \"2. high\": \"192.9900\",\r\n            \"3. low\": \"192.9000\",\r\n            \"4. close\": \"192.9900\",\r\n            \"5. volume\": \"84\"\r\n        },\r\n        \"2024-03-04 17:40:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.8300\",\r\n            \"4. close\": \"192.9000\",\r\n            \"5. volume\": \"181\"\r\n        },\r\n        \"2024-03-04 17:35:00\": {\r\n            \"1. open\": \"192.9600\",\r\n            \"2. high\": \"192.9700\",\r\n            \"3. low\": \"192.8600\",\r\n            \"4. close\": \"192.9000\",\r\n            \"5. volume\": \"175\"\r\n        },\r\n        \"2024-03-04 17:25:00\": {\r\n            \"1. open\": \"192.8800\",\r\n            \"2. high\": \"192.9600\",\r\n            \"3. low\": \"192.8800\",\r\n            \"4. close\": \"192.9600\",\r\n            \"5. volume\": \"84\"\r\n        },\r\n        \"2024-03-04 17:20:00\": {\r\n            \"1. open\": \"192.7500\",\r\n            \"2. high\": \"192.8300\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"11\"\r\n        },\r\n        \"2024-03-04 17:15:00\": {\r\n            \"1. open\": \"192.9300\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.9300\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"250\"\r\n        },\r\n        \"2024-03-04 17:10:00\": {\r\n            \"1. open\": \"193.0000\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.7500\",\r\n            \"5. volume\": \"59\"\r\n        },\r\n        \"2024-03-04 17:05:00\": {\r\n            \"1. open\": \"192.8200\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.8200\",\r\n            \"5. volume\": \"17\"\r\n        },\r\n        \"2024-03-04 17:00:00\": {\r\n            \"1. open\": \"192.9300\",\r\n            \"2. high\": \"193.0600\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.7600\",\r\n            \"5. volume\": \"191\"\r\n        },\r\n        \"2024-03-04 16:55:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.0600\",\r\n            \"3. low\": \"192.7000\",\r\n            \"4. close\": \"192.9400\",\r\n            \"5. volume\": \"213\"\r\n        },\r\n        \"2024-03-04 16:50:00\": {\r\n            \"1. open\": \"192.9900\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.7000\",\r\n            \"4. close\": \"192.8300\",\r\n            \"5. volume\": \"241\"\r\n        },\r\n        \"2024-03-04 16:40:00\": {\r\n            \"1. open\": \"192.9900\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.9800\",\r\n            \"4. close\": \"192.9800\",\r\n            \"5. volume\": \"10\"\r\n        },\r\n        \"2024-03-04 16:35:00\": {\r\n            \"1. open\": \"192.9900\",\r\n            \"2. high\": \"192.9900\",\r\n            \"3. low\": \"192.9900\",\r\n            \"4. close\": \"192.9900\",\r\n            \"5. volume\": \"32\"\r\n        },\r\n        \"2024-03-04 16:30:00\": {\r\n            \"1. open\": \"192.6500\",\r\n            \"2. high\": \"192.9200\",\r\n            \"3. low\": \"192.1430\",\r\n            \"4. close\": \"192.7100\",\r\n            \"5. volume\": \"1210\"\r\n        },\r\n        \"2024-03-04 16:25:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.1000\",\r\n            \"3. low\": \"192.1140\",\r\n            \"4. close\": \"192.8000\",\r\n            \"5. volume\": \"2564\"\r\n        },\r\n        \"2024-03-04 16:20:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.1000\",\r\n            \"3. low\": \"186.8650\",\r\n            \"4. close\": \"192.1000\",\r\n            \"5. volume\": \"1390\"\r\n        },\r\n        \"2024-03-04 16:15:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.1000\",\r\n            \"3. low\": \"192.0000\",\r\n            \"4. close\": \"193.1000\",\r\n            \"5. volume\": \"1710\"\r\n        },\r\n        \"2024-03-04 16:10:00\": {\r\n            \"1. open\": \"193.0600\",\r\n            \"2. high\": \"193.0800\",\r\n            \"3. low\": \"192.9100\",\r\n            \"4. close\": \"192.9100\",\r\n            \"5. volume\": \"827503\"\r\n        },\r\n        \"2024-03-04 16:05:00\": {\r\n            \"1. open\": \"193.3200\",\r\n            \"2. high\": \"193.3300\",\r\n            \"3. low\": \"193.0300\",\r\n            \"4. close\": \"193.1000\",\r\n            \"5. volume\": \"1301\"\r\n        },\r\n        \"2024-03-04 16:00:00\": {\r\n            \"1. open\": \"193.0900\",\r\n            \"2. high\": \"193.0900\",\r\n            \"3. low\": \"193.0400\",\r\n            \"4. close\": \"193.0700\",\r\n            \"5. volume\": \"1762923\"\r\n        },\r\n        \"2024-03-04 15:55:00\": {\r\n            \"1. open\": \"192.8800\",\r\n            \"2. high\": \"193.2500\",\r\n            \"3. low\": \"192.7800\",\r\n            \"4. close\": \"193.0900\",\r\n            \"5. volume\": \"580448\"\r\n        },\r\n        \"2024-03-04 15:50:00\": {\r\n            \"1. open\": \"193.0100\",\r\n            \"2. high\": \"193.1900\",\r\n            \"3. low\": \"192.8400\",\r\n            \"4. close\": \"192.8750\",\r\n            \"5. volume\": \"201801\"\r\n        },\r\n        \"2024-03-04 15:45:00\": {\r\n            \"1. open\": \"193.1850\",\r\n            \"2. high\": \"193.1850\",\r\n            \"3. low\": \"192.8330\",\r\n            \"4. close\": \"192.9850\",\r\n            \"5. volume\": \"125420\"\r\n        },\r\n        \"2024-03-04 15:40:00\": {\r\n            \"1. open\": \"193.1550\",\r\n            \"2. high\": \"193.3700\",\r\n            \"3. low\": \"193.1550\",\r\n            \"4. close\": \"193.1900\",\r\n            \"5. volume\": \"90633\"\r\n        },\r\n        \"2024-03-04 15:35:00\": {\r\n            \"1. open\": \"193.2450\",\r\n            \"2. high\": \"193.2450\",\r\n            \"3. low\": \"192.8950\",\r\n            \"4. close\": \"193.1500\",\r\n            \"5. volume\": \"105389\"\r\n        },\r\n        \"2024-03-04 15:30:00\": {\r\n            \"1. open\": \"193.1800\",\r\n            \"2. high\": \"193.4700\",\r\n            \"3. low\": \"193.1740\",\r\n            \"4. close\": \"193.2250\",\r\n            \"5. volume\": \"83140\"\r\n        },\r\n        \"2024-03-04 15:25:00\": {\r\n            \"1. open\": \"193.4450\",\r\n            \"2. high\": \"193.4800\",\r\n            \"3. low\": \"193.1600\",\r\n            \"4. close\": \"193.1800\",\r\n            \"5. volume\": \"67123\"\r\n        },\r\n        \"2024-03-04 15:20:00\": {\r\n            \"1. open\": \"193.7250\",\r\n            \"2. high\": \"193.7300\",\r\n            \"3. low\": \"193.4300\",\r\n            \"4. close\": \"193.4450\",\r\n            \"5. volume\": \"60658\"\r\n        },\r\n        \"2024-03-04 15:15:00\": {\r\n            \"1. open\": \"193.7100\",\r\n            \"2. high\": \"193.8950\",\r\n            \"3. low\": \"193.6500\",\r\n            \"4. close\": \"193.7200\",\r\n            \"5. volume\": \"72585\"\r\n        },\r\n        \"2024-03-04 15:10:00\": {\r\n            \"1. open\": \"193.7600\",\r\n            \"2. high\": \"193.8980\",\r\n            \"3. low\": \"193.6700\",\r\n            \"4. close\": \"193.7190\",\r\n            \"5. volume\": \"80664\"\r\n        },\r\n        \"2024-03-04 15:05:00\": {\r\n            \"1. open\": \"193.2750\",\r\n            \"2. high\": \"193.7700\",\r\n            \"3. low\": \"193.2600\",\r\n            \"4. close\": \"193.7700\",\r\n            \"5. volume\": \"79541\"\r\n        },\r\n        \"2024-03-04 15:00:00\": {\r\n            \"1. open\": \"193.3100\",\r\n            \"2. high\": \"193.3400\",\r\n            \"3. low\": \"193.2000\",\r\n            \"4. close\": \"193.2800\",\r\n            \"5. volume\": \"52361\"\r\n        },\r\n        \"2024-03-04 14:55:00\": {\r\n            \"1. open\": \"193.4600\",\r\n            \"2. high\": \"193.5700\",\r\n            \"3. low\": \"193.3200\",\r\n            \"4. close\": \"193.3300\",\r\n            \"5. volume\": \"60657\"\r\n        },\r\n        \"2024-03-04 14:50:00\": {\r\n            \"1. open\": \"193.2100\",\r\n            \"2. high\": \"193.4900\",\r\n            \"3. low\": \"193.1800\",\r\n            \"4. close\": \"193.4750\",\r\n            \"5. volume\": \"55026\"\r\n        },\r\n        \"2024-03-04 14:45:00\": {\r\n            \"1. open\": \"193.2600\",\r\n            \"2. high\": \"193.3400\",\r\n            \"3. low\": \"193.1550\",\r\n            \"4. close\": \"193.1970\",\r\n            \"5. volume\": \"54112\"\r\n        },\r\n        \"2024-03-04 14:40:00\": {\r\n            \"1. open\": \"193.2300\",\r\n            \"2. high\": \"193.2550\",\r\n            \"3. low\": \"193.0400\",\r\n            \"4. close\": \"193.2500\",\r\n            \"5. volume\": \"39696\"\r\n        },\r\n        \"2024-03-04 14:35:00\": {\r\n            \"1. open\": \"192.9240\",\r\n            \"2. high\": \"193.1960\",\r\n            \"3. low\": \"192.9000\",\r\n            \"4. close\": \"193.1970\",\r\n            \"5. volume\": \"75236\"\r\n        },\r\n        \"2024-03-04 14:30:00\": {\r\n            \"1. open\": \"192.8550\",\r\n            \"2. high\": \"192.9900\",\r\n            \"3. low\": \"192.7100\",\r\n            \"4. close\": \"192.9150\",\r\n            \"5. volume\": \"64284\"\r\n        },\r\n        \"2024-03-04 14:25:00\": {\r\n            \"1. open\": \"193.0800\",\r\n            \"2. high\": \"193.1100\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.8550\",\r\n            \"5. volume\": \"58398\"\r\n        },\r\n        \"2024-03-04 14:20:00\": {\r\n            \"1. open\": \"193.1850\",\r\n            \"2. high\": \"193.2000\",\r\n            \"3. low\": \"193.0200\",\r\n            \"4. close\": \"193.0890\",\r\n            \"5. volume\": \"47527\"\r\n        },\r\n        \"2024-03-04 14:15:00\": {\r\n            \"1. open\": \"193.0200\",\r\n            \"2. high\": \"193.2100\",\r\n            \"3. low\": \"193.0000\",\r\n            \"4. close\": \"193.2000\",\r\n            \"5. volume\": \"66474\"\r\n        },\r\n        \"2024-03-04 14:10:00\": {\r\n            \"1. open\": \"192.9150\",\r\n            \"2. high\": \"193.0500\",\r\n            \"3. low\": \"192.8500\",\r\n            \"4. close\": \"193.0200\",\r\n            \"5. volume\": \"41273\"\r\n        },\r\n        \"2024-03-04 14:05:00\": {\r\n            \"1. open\": \"192.9500\",\r\n            \"2. high\": \"192.9800\",\r\n            \"3. low\": \"192.8600\",\r\n            \"4. close\": \"192.9100\",\r\n            \"5. volume\": \"38634\"\r\n        },\r\n        \"2024-03-04 14:00:00\": {\r\n            \"1. open\": \"192.9700\",\r\n            \"2. high\": \"193.0550\",\r\n            \"3. low\": \"192.8700\",\r\n            \"4. close\": \"192.9700\",\r\n            \"5. volume\": \"40776\"\r\n        },\r\n        \"2024-03-04 13:55:00\": {\r\n            \"1. open\": \"192.7800\",\r\n            \"2. high\": \"193.0800\",\r\n            \"3. low\": \"192.7100\",\r\n            \"4. close\": \"192.9650\",\r\n            \"5. volume\": \"53267\"\r\n        },\r\n        \"2024-03-04 13:50:00\": {\r\n            \"1. open\": \"192.7530\",\r\n            \"2. high\": \"192.7900\",\r\n            \"3. low\": \"192.7000\",\r\n            \"4. close\": \"192.7700\",\r\n            \"5. volume\": \"25120\"\r\n        },\r\n        \"2024-03-04 13:45:00\": {\r\n            \"1. open\": \"192.8000\",\r\n            \"2. high\": \"192.9200\",\r\n            \"3. low\": \"192.7500\",\r\n            \"4. close\": \"192.7700\",\r\n            \"5. volume\": \"48897\"\r\n        },\r\n        \"2024-03-04 13:40:00\": {\r\n            \"1. open\": \"192.4100\",\r\n            \"2. high\": \"192.7700\",\r\n            \"3. low\": \"192.3700\",\r\n            \"4. close\": \"192.7700\",\r\n            \"5. volume\": \"39407\"\r\n        },\r\n        \"2024-03-04 13:35:00\": {\r\n            \"1. open\": \"192.4650\",\r\n            \"2. high\": \"192.5400\",\r\n            \"3. low\": \"192.3400\",\r\n            \"4. close\": \"192.4250\",\r\n            \"5. volume\": \"32444\"\r\n        },\r\n        \"2024-03-04 13:30:00\": {\r\n            \"1. open\": \"192.6900\",\r\n            \"2. high\": \"192.6900\",\r\n            \"3. low\": \"192.4650\",\r\n            \"4. close\": \"192.4650\",\r\n            \"5. volume\": \"43441\"\r\n        },\r\n        \"2024-03-04 13:25:00\": {\r\n            \"1. open\": \"192.6700\",\r\n            \"2. high\": \"192.7600\",\r\n            \"3. low\": \"192.5810\",\r\n            \"4. close\": \"192.7050\",\r\n            \"5. volume\": \"36610\"\r\n        },\r\n        \"2024-03-04 13:20:00\": {\r\n            \"1. open\": \"192.9800\",\r\n            \"2. high\": \"193.0500\",\r\n            \"3. low\": \"192.5860\",\r\n            \"4. close\": \"192.6850\",\r\n            \"5. volume\": \"60296\"\r\n        },\r\n        \"2024-03-04 13:15:00\": {\r\n            \"1. open\": \"193.2100\",\r\n            \"2. high\": \"193.2100\",\r\n            \"3. low\": \"192.9900\",\r\n            \"4. close\": \"192.9900\",\r\n            \"5. volume\": \"37110\"\r\n        },\r\n        \"2024-03-04 13:10:00\": {\r\n            \"1. open\": \"193.2100\",\r\n            \"2. high\": \"193.3000\",\r\n            \"3. low\": \"193.1380\",\r\n            \"4. close\": \"193.2100\",\r\n            \"5. volume\": \"37445\"\r\n        },\r\n        \"2024-03-04 13:05:00\": {\r\n            \"1. open\": \"192.9400\",\r\n            \"2. high\": \"193.2200\",\r\n            \"3. low\": \"192.9100\",\r\n            \"4. close\": \"193.2000\",\r\n            \"5. volume\": \"42440\"\r\n        },\r\n        \"2024-03-04 13:00:00\": {\r\n            \"1. open\": \"192.9900\",\r\n            \"2. high\": \"193.0200\",\r\n            \"3. low\": \"192.8800\",\r\n            \"4. close\": \"192.9500\",\r\n            \"5. volume\": \"35313\"\r\n        },\r\n        \"2024-03-04 12:55:00\": {\r\n            \"1. open\": \"192.9410\",\r\n            \"2. high\": \"193.0600\",\r\n            \"3. low\": \"192.9400\",\r\n            \"4. close\": \"192.9650\",\r\n            \"5. volume\": \"44466\"\r\n        },\r\n        \"2024-03-04 12:50:00\": {\r\n            \"1. open\": \"193.0200\",\r\n            \"2. high\": \"193.1300\",\r\n            \"3. low\": \"192.9200\",\r\n            \"4. close\": \"192.9650\",\r\n            \"5. volume\": \"44487\"\r\n        },\r\n        \"2024-03-04 12:45:00\": {\r\n            \"1. open\": \"193.1000\",\r\n            \"2. high\": \"193.2400\",\r\n            \"3. low\": \"192.9600\",\r\n            \"4. close\": \"192.9600\",\r\n            \"5. volume\": \"47655\"\r\n        },\r\n        \"2024-03-04 12:40:00\": {\r\n            \"1. open\": \"193.3000\",\r\n            \"2. high\": \"193.3000\",\r\n            \"3. low\": \"193.0900\",\r\n            \"4. close\": \"193.1100\",\r\n            \"5. volume\": \"49671\"\r\n        },\r\n        \"2024-03-04 12:35:00\": {\r\n            \"1. open\": \"193.2700\",\r\n            \"2. high\": \"193.3900\",\r\n            \"3. low\": \"193.2000\",\r\n            \"4. close\": \"193.3000\",\r\n            \"5. volume\": \"41284\"\r\n        },\r\n        \"2024-03-04 12:30:00\": {\r\n            \"1. open\": \"193.4450\",\r\n            \"2. high\": \"193.4900\",\r\n            \"3. low\": \"193.3000\",\r\n            \"4. close\": \"193.3000\",\r\n            \"5. volume\": \"32983\"\r\n        },\r\n        \"2024-03-04 12:25:00\": {\r\n            \"1. open\": \"193.5110\",\r\n            \"2. high\": \"193.5900\",\r\n            \"3. low\": \"193.3500\",\r\n            \"4. close\": \"193.4400\",\r\n            \"5. volume\": \"48534\"\r\n        },\r\n        \"2024-03-04 12:20:00\": {\r\n            \"1. open\": \"193.2900\",\r\n            \"2. high\": \"193.6600\",\r\n            \"3. low\": \"193.2420\",\r\n            \"4. close\": \"193.5300\",\r\n            \"5. volume\": \"50665\"\r\n        },\r\n        \"2024-03-04 12:15:00\": {\r\n            \"1. open\": \"192.8100\",\r\n            \"2. high\": \"193.3100\",\r\n            \"3. low\": \"192.8000\",\r\n            \"4. close\": \"193.2270\",\r\n            \"5. volume\": \"57393\"\r\n        },\r\n        \"2024-03-04 12:10:00\": {\r\n            \"1. open\": \"192.8100\",\r\n            \"2. high\": \"193.0000\",\r\n            \"3. low\": \"192.6900\",\r\n            \"4. close\": \"192.7750\",\r\n            \"5. volume\": \"51095\"\r\n        },\r\n        \"2024-03-04 12:05:00\": {\r\n            \"1. open\": \"192.8300\",\r\n            \"2. high\": \"192.8800\",\r\n            \"3. low\": \"192.5800\",\r\n            \"4. close\": \"192.8000\",\r\n            \"5. volume\": \"95355\"\r\n        },\r\n        \"2024-03-04 12:00:00\": {\r\n            \"1. open\": \"192.9500\",\r\n            \"2. high\": \"192.9500\",\r\n            \"3. low\": \"192.6500\",\r\n            \"4. close\": \"192.8000\",\r\n            \"5. volume\": \"44593\"\r\n        },\r\n        \"2024-03-04 11:55:00\": {\r\n            \"1. open\": \"193.0150\",\r\n            \"2. high\": \"193.1650\",\r\n            \"3. low\": \"192.8000\",\r\n            \"4. close\": \"192.9200\",\r\n            \"5. volume\": \"80069\"\r\n        },\r\n        \"2024-03-04 11:50:00\": {\r\n            \"1. open\": \"193.3500\",\r\n            \"2. high\": \"193.4800\",\r\n            \"3. low\": \"192.9400\",\r\n            \"4. close\": \"193.0000\",\r\n            \"5. volume\": \"62387\"\r\n        },\r\n        \"2024-03-04 11:45:00\": {\r\n            \"1. open\": \"193.0500\",\r\n            \"2. high\": \"193.4300\",\r\n            \"3. low\": \"193.0200\",\r\n            \"4. close\": \"193.3600\",\r\n            \"5. volume\": \"89243\"\r\n        },\r\n        \"2024-03-04 11:40:00\": {\r\n            \"1. open\": \"192.6900\",\r\n            \"2. high\": \"193.1200\",\r\n            \"3. low\": \"192.6700\",\r\n            \"4. close\": \"193.0200\",\r\n            \"5. volume\": \"89631\"\r\n        },\r\n        \"2024-03-04 11:35:00\": {\r\n            \"1. open\": \"192.6400\",\r\n            \"2. high\": \"192.8200\",\r\n            \"3. low\": \"192.6000\",\r\n            \"4. close\": \"192.6700\",\r\n            \"5. volume\": \"83132\"\r\n        },\r\n        \"2024-03-04 11:30:00\": {\r\n            \"1. open\": \"192.8800\",\r\n            \"2. high\": \"193.2000\",\r\n            \"3. low\": \"192.6400\",\r\n            \"4. close\": \"192.6400\",\r\n            \"5. volume\": \"156853\"\r\n        },\r\n        \"2024-03-04 11:25:00\": {\r\n            \"1. open\": \"192.3900\",\r\n            \"2. high\": \"192.8800\",\r\n            \"3. low\": \"192.2800\",\r\n            \"4. close\": \"192.8800\",\r\n            \"5. volume\": \"129837\"\r\n        },\r\n        \"2024-03-04 11:20:00\": {\r\n            \"1. open\": \"191.9700\",\r\n            \"2. high\": \"192.4800\",\r\n            \"3. low\": \"191.9700\",\r\n            \"4. close\": \"192.4000\",\r\n            \"5. volume\": \"112703\"\r\n        },\r\n        \"2024-03-04 11:15:00\": {\r\n            \"1. open\": \"191.4800\",\r\n            \"2. high\": \"191.9900\",\r\n            \"3. low\": \"191.3770\",\r\n            \"4. close\": \"191.9900\",\r\n            \"5. volume\": \"121030\"\r\n        }\r\n    }\r\n}";
                        
                        StockIntradayApiResponseDto stockApiResponse = JsonConvert.DeserializeObject<StockIntradayApiResponseDto>(ApiResponse);
                        MetaDataIntradayApiResponseDto metaData = stockApiResponse.MetaData;
                        Dictionary<string, TimeSeriesDataIntradayApiResponseDto> timeSeries = stockApiResponse.TimeSeries;

                        // Map dto to domain model
                        var stock = new Stock
                        {
                            Symbol = metaData.Symbol,
                            Interval = metaData.Interval,
                            OutputSize = metaData.OutputSize,
                            TimeZone = metaData.TimeZone,
                            TimeSeries = timeSeries.Select(ts => new TimeSeriesData
                            {
                                TimeStamp = DateTime.Parse(ts.Key),
                                Open = ts.Value.Open,
                                High = ts.Value.High,
                                Low = ts.Value.Low,
                                Close = ts.Value.Close,
                                Volume = ts.Value.Volume
                            }).ToList()
                        };

                        stock = await stockRepository.CreateAsync(stock);

                        // Domain model to DTO
                        var response = new StockDto
                        {
                            Id = stock.Id,
                            Symbol = stock.Symbol,
                            Interval = stock.Interval,
                            OutputSize = stock.OutputSize,
                            TimeZone = stock.TimeZone,
                            TimeSeries = stock.TimeSeries.Select(ts => new TimeSeriesDataDto
                            {
                                TimeStamp = ts.TimeStamp,
                                Open = ts.Open,
                                High = ts.High,
                                Low = ts.Low,
                                Close = ts.Close,
                                Volume = ts.Volume
                            }).ToList()
                        };

                        return Ok(response);
                    }
                    else
                    {
                        // testing string
                        ApiResponse = "{\r\n    \"Meta Data\": {\r\n        \"1. Information\": \"Daily Prices (open, high, low, close) and Volumes\",\r\n        \"2. Symbol\": \"IBM\",\r\n        \"3. Last Refreshed\": \"2024-03-04\",\r\n        \"4. Output Size\": \"Compact\",\r\n        \"5. Time Zone\": \"US/Eastern\"\r\n    },\r\n    \"Time Series (Daily)\": {\r\n        \"2024-03-04\": {\r\n            \"1. open\": \"187.7600\",\r\n            \"2. high\": \"193.8980\",\r\n            \"3. low\": \"187.6000\",\r\n            \"4. close\": \"193.0600\",\r\n            \"5. volume\": \"7938266\"\r\n        },\r\n        \"2024-03-01\": {\r\n            \"1. open\": \"185.4900\",\r\n            \"2. high\": \"188.3800\",\r\n            \"3. low\": \"185.1800\",\r\n            \"4. close\": \"188.2000\",\r\n            \"5. volume\": \"4018354\"\r\n        },\r\n        \"2024-02-29\": {\r\n            \"1. open\": \"186.1500\",\r\n            \"2. high\": \"186.8495\",\r\n            \"3. low\": \"184.6900\",\r\n            \"4. close\": \"185.0300\",\r\n            \"5. volume\": \"6458487\"\r\n        },\r\n        \"2024-02-28\": {\r\n            \"1. open\": \"184.6300\",\r\n            \"2. high\": \"185.3700\",\r\n            \"3. low\": \"183.5500\",\r\n            \"4. close\": \"185.3000\",\r\n            \"5. volume\": \"3216345\"\r\n        },\r\n        \"2024-02-27\": {\r\n            \"1. open\": \"184.1600\",\r\n            \"2. high\": \"185.1300\",\r\n            \"3. low\": \"182.6200\",\r\n            \"4. close\": \"184.8700\",\r\n            \"5. volume\": \"3641378\"\r\n        },\r\n        \"2024-02-26\": {\r\n            \"1. open\": \"185.6000\",\r\n            \"2. high\": \"186.1250\",\r\n            \"3. low\": \"184.0600\",\r\n            \"4. close\": \"184.1300\",\r\n            \"5. volume\": \"4620815\"\r\n        },\r\n        \"2024-02-23\": {\r\n            \"1. open\": \"184.9000\",\r\n            \"2. high\": \"186.4550\",\r\n            \"3. low\": \"184.5700\",\r\n            \"4. close\": \"185.7200\",\r\n            \"5. volume\": \"3433800\"\r\n        },\r\n        \"2024-02-22\": {\r\n            \"1. open\": \"182.4500\",\r\n            \"2. high\": \"184.5500\",\r\n            \"3. low\": \"181.9300\",\r\n            \"4. close\": \"184.2100\",\r\n            \"5. volume\": \"5078398\"\r\n        },\r\n        \"2024-02-21\": {\r\n            \"1. open\": \"182.5600\",\r\n            \"2. high\": \"183.0300\",\r\n            \"3. low\": \"178.7500\",\r\n            \"4. close\": \"179.7000\",\r\n            \"5. volume\": \"4728473\"\r\n        },\r\n        \"2024-02-20\": {\r\n            \"1. open\": \"187.6400\",\r\n            \"2. high\": \"188.7700\",\r\n            \"3. low\": \"183.0600\",\r\n            \"4. close\": \"183.4400\",\r\n            \"5. volume\": \"4247181\"\r\n        },\r\n        \"2024-02-16\": {\r\n            \"1. open\": \"186.6300\",\r\n            \"2. high\": \"188.9500\",\r\n            \"3. low\": \"185.9452\",\r\n            \"4. close\": \"187.6400\",\r\n            \"5. volume\": \"4842840\"\r\n        },\r\n        \"2024-02-15\": {\r\n            \"1. open\": \"183.6200\",\r\n            \"2. high\": \"186.9800\",\r\n            \"3. low\": \"183.6200\",\r\n            \"4. close\": \"186.8700\",\r\n            \"5. volume\": \"4714301\"\r\n        },\r\n        \"2024-02-14\": {\r\n            \"1. open\": \"185.0000\",\r\n            \"2. high\": \"185.0000\",\r\n            \"3. low\": \"182.2600\",\r\n            \"4. close\": \"183.5700\",\r\n            \"5. volume\": \"3173391\"\r\n        },\r\n        \"2024-02-13\": {\r\n            \"1. open\": \"184.2800\",\r\n            \"2. high\": \"184.7700\",\r\n            \"3. low\": \"182.3600\",\r\n            \"4. close\": \"183.7000\",\r\n            \"5. volume\": \"4290453\"\r\n        },\r\n        \"2024-02-12\": {\r\n            \"1. open\": \"185.9000\",\r\n            \"2. high\": \"186.4800\",\r\n            \"3. low\": \"184.0300\",\r\n            \"4. close\": \"186.1600\",\r\n            \"5. volume\": \"4724021\"\r\n        },\r\n        \"2024-02-09\": {\r\n            \"1. open\": \"184.4400\",\r\n            \"2. high\": \"187.1800\",\r\n            \"3. low\": \"183.8500\",\r\n            \"4. close\": \"186.3400\",\r\n            \"5. volume\": \"5064641\"\r\n        },\r\n        \"2024-02-08\": {\r\n            \"1. open\": \"182.6300\",\r\n            \"2. high\": \"184.5500\",\r\n            \"3. low\": \"181.4900\",\r\n            \"4. close\": \"184.3600\",\r\n            \"5. volume\": \"5161185\"\r\n        },\r\n        \"2024-02-07\": {\r\n            \"1. open\": \"183.3400\",\r\n            \"2. high\": \"184.0200\",\r\n            \"3. low\": \"182.6250\",\r\n            \"4. close\": \"183.7400\",\r\n            \"5. volume\": \"4841188\"\r\n        },\r\n        \"2024-02-06\": {\r\n            \"1. open\": \"183.5500\",\r\n            \"2. high\": \"184.6800\",\r\n            \"3. low\": \"183.0400\",\r\n            \"4. close\": \"183.4100\",\r\n            \"5. volume\": \"3338196\"\r\n        },\r\n        \"2024-02-05\": {\r\n            \"1. open\": \"185.5100\",\r\n            \"2. high\": \"185.7800\",\r\n            \"3. low\": \"183.2550\",\r\n            \"4. close\": \"183.4200\",\r\n            \"5. volume\": \"4379602\"\r\n        },\r\n        \"2024-02-02\": {\r\n            \"1. open\": \"187.1000\",\r\n            \"2. high\": \"187.3900\",\r\n            \"3. low\": \"185.6150\",\r\n            \"4. close\": \"185.7900\",\r\n            \"5. volume\": \"4055411\"\r\n        },\r\n        \"2024-02-01\": {\r\n            \"1. open\": \"183.6300\",\r\n            \"2. high\": \"187.5100\",\r\n            \"3. low\": \"182.7100\",\r\n            \"4. close\": \"186.9000\",\r\n            \"5. volume\": \"4669444\"\r\n        },\r\n        \"2024-01-31\": {\r\n            \"1. open\": \"187.0500\",\r\n            \"2. high\": \"187.6500\",\r\n            \"3. low\": \"183.1400\",\r\n            \"4. close\": \"183.6600\",\r\n            \"5. volume\": \"8876055\"\r\n        },\r\n        \"2024-01-30\": {\r\n            \"1. open\": \"187.7100\",\r\n            \"2. high\": \"188.6500\",\r\n            \"3. low\": \"186.7700\",\r\n            \"4. close\": \"187.8700\",\r\n            \"5. volume\": \"4575058\"\r\n        },\r\n        \"2024-01-29\": {\r\n            \"1. open\": \"187.4600\",\r\n            \"2. high\": \"189.4600\",\r\n            \"3. low\": \"186.0500\",\r\n            \"4. close\": \"187.1400\",\r\n            \"5. volume\": \"6107908\"\r\n        },\r\n        \"2024-01-26\": {\r\n            \"1. open\": \"191.3100\",\r\n            \"2. high\": \"192.3896\",\r\n            \"3. low\": \"186.1600\",\r\n            \"4. close\": \"187.4200\",\r\n            \"5. volume\": \"9895941\"\r\n        },\r\n        \"2024-01-25\": {\r\n            \"1. open\": \"184.9600\",\r\n            \"2. high\": \"196.9000\",\r\n            \"3. low\": \"184.8300\",\r\n            \"4. close\": \"190.4300\",\r\n            \"5. volume\": \"29596239\"\r\n        },\r\n        \"2024-01-24\": {\r\n            \"1. open\": \"174.7600\",\r\n            \"2. high\": \"174.8600\",\r\n            \"3. low\": \"172.9000\",\r\n            \"4. close\": \"173.9300\",\r\n            \"5. volume\": \"7831157\"\r\n        },\r\n        \"2024-01-23\": {\r\n            \"1. open\": \"172.9000\",\r\n            \"2. high\": \"174.0200\",\r\n            \"3. low\": \"172.4800\",\r\n            \"4. close\": \"173.9400\",\r\n            \"5. volume\": \"3983461\"\r\n        },\r\n        \"2024-01-22\": {\r\n            \"1. open\": \"172.8200\",\r\n            \"2. high\": \"174.4500\",\r\n            \"3. low\": \"172.4000\",\r\n            \"4. close\": \"172.8300\",\r\n            \"5. volume\": \"4925964\"\r\n        },\r\n        \"2024-01-19\": {\r\n            \"1. open\": \"170.5900\",\r\n            \"2. high\": \"171.5791\",\r\n            \"3. low\": \"169.1800\",\r\n            \"4. close\": \"171.4800\",\r\n            \"5. volume\": \"6929079\"\r\n        },\r\n        \"2024-01-18\": {\r\n            \"1. open\": \"166.4900\",\r\n            \"2. high\": \"166.9900\",\r\n            \"3. low\": \"165.0400\",\r\n            \"4. close\": \"166.8400\",\r\n            \"5. volume\": \"3776990\"\r\n        },\r\n        \"2024-01-17\": {\r\n            \"1. open\": \"166.7900\",\r\n            \"2. high\": \"167.8200\",\r\n            \"3. low\": \"165.4950\",\r\n            \"4. close\": \"166.0800\",\r\n            \"5. volume\": \"4288604\"\r\n        },\r\n        \"2024-01-16\": {\r\n            \"1. open\": \"165.8000\",\r\n            \"2. high\": \"167.2500\",\r\n            \"3. low\": \"165.3400\",\r\n            \"4. close\": \"166.9600\",\r\n            \"5. volume\": \"4869635\"\r\n        },\r\n        \"2024-01-12\": {\r\n            \"1. open\": \"162.9700\",\r\n            \"2. high\": \"165.9800\",\r\n            \"3. low\": \"162.3550\",\r\n            \"4. close\": \"165.8000\",\r\n            \"5. volume\": \"4958261\"\r\n        },\r\n        \"2024-01-11\": {\r\n            \"1. open\": \"161.0200\",\r\n            \"2. high\": \"162.2300\",\r\n            \"3. low\": \"160.2900\",\r\n            \"4. close\": \"162.1600\",\r\n            \"5. volume\": \"3778395\"\r\n        },\r\n        \"2024-01-10\": {\r\n            \"1. open\": \"160.2800\",\r\n            \"2. high\": \"161.3400\",\r\n            \"3. low\": \"159.7400\",\r\n            \"4. close\": \"161.2300\",\r\n            \"5. volume\": \"2967852\"\r\n        },\r\n        \"2024-01-09\": {\r\n            \"1. open\": \"160.0000\",\r\n            \"2. high\": \"160.4837\",\r\n            \"3. low\": \"159.5100\",\r\n            \"4. close\": \"160.0800\",\r\n            \"5. volume\": \"2617186\"\r\n        },\r\n        \"2024-01-08\": {\r\n            \"1. open\": \"158.6900\",\r\n            \"2. high\": \"161.2160\",\r\n            \"3. low\": \"157.8850\",\r\n            \"4. close\": \"161.1400\",\r\n            \"5. volume\": \"3321698\"\r\n        },\r\n        \"2024-01-05\": {\r\n            \"1. open\": \"159.9100\",\r\n            \"2. high\": \"160.5500\",\r\n            \"3. low\": \"158.6700\",\r\n            \"4. close\": \"159.1600\",\r\n            \"5. volume\": \"3698961\"\r\n        },\r\n        \"2024-01-04\": {\r\n            \"1. open\": \"160.2200\",\r\n            \"2. high\": \"161.8100\",\r\n            \"3. low\": \"160.1700\",\r\n            \"4. close\": \"160.8600\",\r\n            \"5. volume\": \"3212004\"\r\n        },\r\n        \"2024-01-03\": {\r\n            \"1. open\": \"161.0000\",\r\n            \"2. high\": \"161.7300\",\r\n            \"3. low\": \"160.0800\",\r\n            \"4. close\": \"160.1000\",\r\n            \"5. volume\": \"4086065\"\r\n        },\r\n        \"2024-01-02\": {\r\n            \"1. open\": \"162.8300\",\r\n            \"2. high\": \"163.2900\",\r\n            \"3. low\": \"160.4600\",\r\n            \"4. close\": \"161.5000\",\r\n            \"5. volume\": \"3825044\"\r\n        },\r\n        \"2023-12-29\": {\r\n            \"1. open\": \"163.7500\",\r\n            \"2. high\": \"164.1800\",\r\n            \"3. low\": \"162.8300\",\r\n            \"4. close\": \"163.5500\",\r\n            \"5. volume\": \"2526169\"\r\n        },\r\n        \"2023-12-28\": {\r\n            \"1. open\": \"163.9600\",\r\n            \"2. high\": \"163.9600\",\r\n            \"3. low\": \"163.4000\",\r\n            \"4. close\": \"163.7500\",\r\n            \"5. volume\": \"2071313\"\r\n        },\r\n        \"2023-12-27\": {\r\n            \"1. open\": \"163.1400\",\r\n            \"2. high\": \"163.6400\",\r\n            \"3. low\": \"162.6800\",\r\n            \"4. close\": \"163.4600\",\r\n            \"5. volume\": \"3006612\"\r\n        },\r\n        \"2023-12-26\": {\r\n            \"1. open\": \"162.2300\",\r\n            \"2. high\": \"163.3100\",\r\n            \"3. low\": \"162.0500\",\r\n            \"4. close\": \"163.2100\",\r\n            \"5. volume\": \"1772443\"\r\n        },\r\n        \"2023-12-22\": {\r\n            \"1. open\": \"161.1000\",\r\n            \"2. high\": \"162.4100\",\r\n            \"3. low\": \"161.0000\",\r\n            \"4. close\": \"162.1400\",\r\n            \"5. volume\": \"2442715\"\r\n        },\r\n        \"2023-12-21\": {\r\n            \"1. open\": \"160.5900\",\r\n            \"2. high\": \"161.0800\",\r\n            \"3. low\": \"159.5300\",\r\n            \"4. close\": \"160.7800\",\r\n            \"5. volume\": \"2982924\"\r\n        },\r\n        \"2023-12-20\": {\r\n            \"1. open\": \"161.2900\",\r\n            \"2. high\": \"161.8000\",\r\n            \"3. low\": \"160.0100\",\r\n            \"4. close\": \"160.0500\",\r\n            \"5. volume\": \"4865797\"\r\n        },\r\n        \"2023-12-19\": {\r\n            \"1. open\": \"161.8000\",\r\n            \"2. high\": \"162.2800\",\r\n            \"3. low\": \"161.3200\",\r\n            \"4. close\": \"161.5600\",\r\n            \"5. volume\": \"3717429\"\r\n        },\r\n        \"2023-12-18\": {\r\n            \"1. open\": \"162.2300\",\r\n            \"2. high\": \"163.3300\",\r\n            \"3. low\": \"161.5766\",\r\n            \"4. close\": \"162.7400\",\r\n            \"5. volume\": \"3677533\"\r\n        },\r\n        \"2023-12-15\": {\r\n            \"1. open\": \"162.3000\",\r\n            \"2. high\": \"164.0900\",\r\n            \"3. low\": \"162.0400\",\r\n            \"4. close\": \"162.2300\",\r\n            \"5. volume\": \"11016108\"\r\n        },\r\n        \"2023-12-14\": {\r\n            \"1. open\": \"162.9300\",\r\n            \"2. high\": \"163.4990\",\r\n            \"3. low\": \"160.1490\",\r\n            \"4. close\": \"162.9100\",\r\n            \"5. volume\": \"6129804\"\r\n        },\r\n        \"2023-12-13\": {\r\n            \"1. open\": \"164.3700\",\r\n            \"2. high\": \"164.9653\",\r\n            \"3. low\": \"162.7350\",\r\n            \"4. close\": \"163.6200\",\r\n            \"5. volume\": \"4989141\"\r\n        },\r\n        \"2023-12-12\": {\r\n            \"1. open\": \"163.2700\",\r\n            \"2. high\": \"166.3400\",\r\n            \"3. low\": \"162.9200\",\r\n            \"4. close\": \"164.7100\",\r\n            \"5. volume\": \"5292290\"\r\n        },\r\n        \"2023-12-11\": {\r\n            \"1. open\": \"162.6800\",\r\n            \"2. high\": \"163.6500\",\r\n            \"3. low\": \"161.9500\",\r\n            \"4. close\": \"163.5100\",\r\n            \"5. volume\": \"6077207\"\r\n        },\r\n        \"2023-12-08\": {\r\n            \"1. open\": \"160.0000\",\r\n            \"2. high\": \"162.0400\",\r\n            \"3. low\": \"160.0000\",\r\n            \"4. close\": \"161.9600\",\r\n            \"5. volume\": \"4561342\"\r\n        },\r\n        \"2023-12-07\": {\r\n            \"1. open\": \"161.0000\",\r\n            \"2. high\": \"161.4650\",\r\n            \"3. low\": \"159.9700\",\r\n            \"4. close\": \"160.2200\",\r\n            \"5. volume\": \"3665498\"\r\n        },\r\n        \"2023-12-06\": {\r\n            \"1. open\": \"161.5900\",\r\n            \"2. high\": \"162.3550\",\r\n            \"3. low\": \"160.0100\",\r\n            \"4. close\": \"160.2800\",\r\n            \"5. volume\": \"3356432\"\r\n        },\r\n        \"2023-12-05\": {\r\n            \"1. open\": \"160.7600\",\r\n            \"2. high\": \"162.4700\",\r\n            \"3. low\": \"160.7200\",\r\n            \"4. close\": \"161.3900\",\r\n            \"5. volume\": \"4556668\"\r\n        },\r\n        \"2023-12-04\": {\r\n            \"1. open\": \"160.2900\",\r\n            \"2. high\": \"162.7900\",\r\n            \"3. low\": \"160.2900\",\r\n            \"4. close\": \"161.1000\",\r\n            \"5. volume\": \"5779017\"\r\n        },\r\n        \"2023-12-01\": {\r\n            \"1. open\": \"158.4100\",\r\n            \"2. high\": \"160.5900\",\r\n            \"3. low\": \"158.0000\",\r\n            \"4. close\": \"160.5500\",\r\n            \"5. volume\": \"4871860\"\r\n        },\r\n        \"2023-11-30\": {\r\n            \"1. open\": \"156.9500\",\r\n            \"2. high\": \"158.6000\",\r\n            \"3. low\": \"156.8900\",\r\n            \"4. close\": \"158.5600\",\r\n            \"5. volume\": \"6740622\"\r\n        },\r\n        \"2023-11-29\": {\r\n            \"1. open\": \"156.1500\",\r\n            \"2. high\": \"157.5100\",\r\n            \"3. low\": \"156.0200\",\r\n            \"4. close\": \"156.4100\",\r\n            \"5. volume\": \"3568887\"\r\n        },\r\n        \"2023-11-28\": {\r\n            \"1. open\": \"155.4400\",\r\n            \"2. high\": \"155.7450\",\r\n            \"3. low\": \"154.8600\",\r\n            \"4. close\": \"155.6500\",\r\n            \"5. volume\": \"2666182\"\r\n        },\r\n        \"2023-11-27\": {\r\n            \"1. open\": \"154.9900\",\r\n            \"2. high\": \"156.1350\",\r\n            \"3. low\": \"154.7500\",\r\n            \"4. close\": \"155.5700\",\r\n            \"5. volume\": \"4053093\"\r\n        },\r\n        \"2023-11-24\": {\r\n            \"1. open\": \"155.1300\",\r\n            \"2. high\": \"155.4000\",\r\n            \"3. low\": \"153.9200\",\r\n            \"4. close\": \"155.1800\",\r\n            \"5. volume\": \"1799161\"\r\n        },\r\n        \"2023-11-22\": {\r\n            \"1. open\": \"154.5000\",\r\n            \"2. high\": \"155.7050\",\r\n            \"3. low\": \"154.1600\",\r\n            \"4. close\": \"155.1300\",\r\n            \"5. volume\": \"3045091\"\r\n        },\r\n        \"2023-11-21\": {\r\n            \"1. open\": \"154.6000\",\r\n            \"2. high\": \"154.6600\",\r\n            \"3. low\": \"153.5100\",\r\n            \"4. close\": \"153.9100\",\r\n            \"5. volume\": \"2859508\"\r\n        },\r\n        \"2023-11-20\": {\r\n            \"1. open\": \"152.5100\",\r\n            \"2. high\": \"154.6800\",\r\n            \"3. low\": \"152.3500\",\r\n            \"4. close\": \"154.3500\",\r\n            \"5. volume\": \"3658936\"\r\n        },\r\n        \"2023-11-17\": {\r\n            \"1. open\": \"153.2900\",\r\n            \"2. high\": \"153.5000\",\r\n            \"3. low\": \"152.4601\",\r\n            \"4. close\": \"152.8900\",\r\n            \"5. volume\": \"4426676\"\r\n        },\r\n        \"2023-11-16\": {\r\n            \"1. open\": \"153.0000\",\r\n            \"2. high\": \"153.3500\",\r\n            \"3. low\": \"152.1300\",\r\n            \"4. close\": \"153.0600\",\r\n            \"5. volume\": \"3519172\"\r\n        },\r\n        \"2023-11-15\": {\r\n            \"1. open\": \"150.4000\",\r\n            \"2. high\": \"153.2200\",\r\n            \"3. low\": \"150.4000\",\r\n            \"4. close\": \"152.5800\",\r\n            \"5. volume\": \"4632519\"\r\n        },\r\n        \"2023-11-14\": {\r\n            \"1. open\": \"149.4500\",\r\n            \"2. high\": \"150.8063\",\r\n            \"3. low\": \"149.0500\",\r\n            \"4. close\": \"150.4100\",\r\n            \"5. volume\": \"4321940\"\r\n        },\r\n        \"2023-11-13\": {\r\n            \"1. open\": \"148.4600\",\r\n            \"2. high\": \"148.4900\",\r\n            \"3. low\": \"147.3500\",\r\n            \"4. close\": \"148.1000\",\r\n            \"5. volume\": \"2647288\"\r\n        },\r\n        \"2023-11-10\": {\r\n            \"1. open\": \"147.4400\",\r\n            \"2. high\": \"149.1700\",\r\n            \"3. low\": \"146.8500\",\r\n            \"4. close\": \"149.0200\",\r\n            \"5. volume\": \"3179541\"\r\n        },\r\n        \"2023-11-09\": {\r\n            \"1. open\": \"146.5500\",\r\n            \"2. high\": \"146.9900\",\r\n            \"3. low\": \"145.2800\",\r\n            \"4. close\": \"146.6200\",\r\n            \"5. volume\": \"3412713\"\r\n        },\r\n        \"2023-11-08\": {\r\n            \"1. open\": \"149.2500\",\r\n            \"2. high\": \"149.6800\",\r\n            \"3. low\": \"147.5850\",\r\n            \"4. close\": \"148.0300\",\r\n            \"5. volume\": \"3618588\"\r\n        },\r\n        \"2023-11-07\": {\r\n            \"1. open\": \"149.0300\",\r\n            \"2. high\": \"149.2800\",\r\n            \"3. low\": \"148.0300\",\r\n            \"4. close\": \"148.8300\",\r\n            \"5. volume\": \"3549853\"\r\n        },\r\n        \"2023-11-06\": {\r\n            \"1. open\": \"147.8900\",\r\n            \"2. high\": \"149.2250\",\r\n            \"3. low\": \"147.8500\",\r\n            \"4. close\": \"148.9700\",\r\n            \"5. volume\": \"4597249\"\r\n        },\r\n        \"2023-11-03\": {\r\n            \"1. open\": \"147.4500\",\r\n            \"2. high\": \"148.4450\",\r\n            \"3. low\": \"147.2800\",\r\n            \"4. close\": \"147.9000\",\r\n            \"5. volume\": \"3510495\"\r\n        },\r\n        \"2023-11-02\": {\r\n            \"1. open\": \"145.7700\",\r\n            \"2. high\": \"147.1000\",\r\n            \"3. low\": \"144.8400\",\r\n            \"4. close\": \"147.0100\",\r\n            \"5. volume\": \"3902657\"\r\n        },\r\n        \"2023-11-01\": {\r\n            \"1. open\": \"145.0000\",\r\n            \"2. high\": \"146.5100\",\r\n            \"3. low\": \"144.4500\",\r\n            \"4. close\": \"145.4000\",\r\n            \"5. volume\": \"4750081\"\r\n        },\r\n        \"2023-10-31\": {\r\n            \"1. open\": \"143.0000\",\r\n            \"2. high\": \"144.7600\",\r\n            \"3. low\": \"142.5900\",\r\n            \"4. close\": \"144.6400\",\r\n            \"5. volume\": \"6592041\"\r\n        },\r\n        \"2023-10-30\": {\r\n            \"1. open\": \"143.1900\",\r\n            \"2. high\": \"144.5000\",\r\n            \"3. low\": \"142.5800\",\r\n            \"4. close\": \"142.6300\",\r\n            \"5. volume\": \"4204190\"\r\n        },\r\n        \"2023-10-27\": {\r\n            \"1. open\": \"143.6200\",\r\n            \"2. high\": \"144.7000\",\r\n            \"3. low\": \"141.7100\",\r\n            \"4. close\": \"142.5200\",\r\n            \"5. volume\": \"5469227\"\r\n        },\r\n        \"2023-10-26\": {\r\n            \"1. open\": \"142.2000\",\r\n            \"2. high\": \"144.4100\",\r\n            \"3. low\": \"141.5800\",\r\n            \"4. close\": \"143.7600\",\r\n            \"5. volume\": \"11130170\"\r\n        },\r\n        \"2023-10-25\": {\r\n            \"1. open\": \"137.5000\",\r\n            \"2. high\": \"138.4900\",\r\n            \"3. low\": \"136.3300\",\r\n            \"4. close\": \"137.0800\",\r\n            \"5. volume\": \"6472549\"\r\n        },\r\n        \"2023-10-24\": {\r\n            \"1. open\": \"136.7400\",\r\n            \"2. high\": \"137.9800\",\r\n            \"3. low\": \"136.0500\",\r\n            \"4. close\": \"137.7900\",\r\n            \"5. volume\": \"3697975\"\r\n        },\r\n        \"2023-10-23\": {\r\n            \"1. open\": \"136.6300\",\r\n            \"2. high\": \"137.6800\",\r\n            \"3. low\": \"135.8700\",\r\n            \"4. close\": \"136.3800\",\r\n            \"5. volume\": \"3457527\"\r\n        },\r\n        \"2023-10-20\": {\r\n            \"1. open\": \"138.1500\",\r\n            \"2. high\": \"139.2700\",\r\n            \"3. low\": \"137.1200\",\r\n            \"4. close\": \"137.1600\",\r\n            \"5. volume\": \"4865615\"\r\n        },\r\n        \"2023-10-19\": {\r\n            \"1. open\": \"138.6400\",\r\n            \"2. high\": \"139.4050\",\r\n            \"3. low\": \"137.9300\",\r\n            \"4. close\": \"138.0100\",\r\n            \"5. volume\": \"5314159\"\r\n        },\r\n        \"2023-10-18\": {\r\n            \"1. open\": \"140.0000\",\r\n            \"2. high\": \"140.4300\",\r\n            \"3. low\": \"139.5800\",\r\n            \"4. close\": \"139.9700\",\r\n            \"5. volume\": \"3329985\"\r\n        },\r\n        \"2023-10-17\": {\r\n            \"1. open\": \"137.1200\",\r\n            \"2. high\": \"140.6200\",\r\n            \"3. low\": \"136.3100\",\r\n            \"4. close\": \"140.3200\",\r\n            \"5. volume\": \"4172822\"\r\n        },\r\n        \"2023-10-16\": {\r\n            \"1. open\": \"139.2800\",\r\n            \"2. high\": \"139.7800\",\r\n            \"3. low\": \"138.5200\",\r\n            \"4. close\": \"139.2100\",\r\n            \"5. volume\": \"3361468\"\r\n        },\r\n        \"2023-10-13\": {\r\n            \"1. open\": \"139.7700\",\r\n            \"2. high\": \"140.1200\",\r\n            \"3. low\": \"138.2700\",\r\n            \"4. close\": \"138.4600\",\r\n            \"5. volume\": \"4583553\"\r\n        },\r\n        \"2023-10-12\": {\r\n            \"1. open\": \"142.5100\",\r\n            \"2. high\": \"142.9300\",\r\n            \"3. low\": \"140.9500\",\r\n            \"4. close\": \"141.2400\",\r\n            \"5. volume\": \"3921142\"\r\n        },\r\n        \"2023-10-11\": {\r\n            \"1. open\": \"142.5100\",\r\n            \"2. high\": \"143.3400\",\r\n            \"3. low\": \"142.1400\",\r\n            \"4. close\": \"143.2300\",\r\n            \"5. volume\": \"2511459\"\r\n        },\r\n        \"2023-10-10\": {\r\n            \"1. open\": \"142.6000\",\r\n            \"2. high\": \"143.4150\",\r\n            \"3. low\": \"141.7200\",\r\n            \"4. close\": \"142.1100\",\r\n            \"5. volume\": \"3015784\"\r\n        }\r\n    }\r\n}";
                        
                        StockApiResponseDto stockApiResponse = JsonConvert.DeserializeObject<StockApiResponseDto>(ApiResponse);
                        MetaDataApiResponseDto metaData = stockApiResponse.MetaData;
                        Dictionary<string, TimeSeriesDataApiResponseDto> timeSeries = stockApiResponse.TimeSeries;

                        // Map dto to domain model
                        var stock = new Stock
                        {
                            Symbol = metaData.Symbol,
                            Interval = request.TimeFrame,
                            OutputSize = metaData.OutputSize,
                            TimeZone = metaData.TimeZone,
                            TimeSeries = timeSeries.Select(ts => new TimeSeriesData
                            {
                                TimeStamp = DateTime.Parse(ts.Key),
                                Open = ts.Value.Open,
                                High = ts.Value.High,
                                Low = ts.Value.Low,
                                Close = ts.Value.Close,
                                Volume = ts.Value.Volume
                            }).ToList()
                        };

                        stock = await stockRepository.CreateAsync(stock);

                        // Domain model to DTO
                        var response = new StockDto
                        {
                            Id = stock.Id,
                            Symbol = stock.Symbol,
                            Interval = request.TimeFrame,
                            OutputSize = stock.OutputSize,
                            TimeZone = stock.TimeZone,
                            TimeSeries = stock.TimeSeries.Select(ts => new TimeSeriesDataDto
                            {
                                TimeStamp = ts.TimeStamp,
                                Open = ts.Open,
                                High = ts.High,
                                Low = ts.Low,
                                Close = ts.Close,
                                Volume = ts.Volume
                            }).ToList()
                        };

                        return Ok(response);
                    }



                    return Ok(ApiResponse);
                }
            }
            catch (Exception ex)
            {
                // Handle exceptions appropriately
                return StatusCode(500, $"An error occurred: {ex.Message}");
            }
        }

        // GET: /api/stocks
        [HttpGet]
        public async Task<IActionResult> GetAllStocks()
        {
            var stocks = await stockRepository.GetAllAsync();

            // Map domain model to dto
            var response = new List<StockDto>();
            foreach (var stock in stocks)
            {
                response.Add(new StockDto
                {
                    Id = stock.Id,
                    Symbol = stock.Symbol,
                    Interval = stock.Interval,
                    OutputSize = stock.OutputSize,
                    TimeZone = stock.TimeZone,
                    TimeSeries = stock.TimeSeries.Select(ts => new TimeSeriesDataDto
                    {
                        TimeStamp = ts.TimeStamp,
                        Open = ts.Open,
                        High = ts.High,
                        Low = ts.Low,
                        Close = ts.Close,
                        Volume = ts.Volume
                    }).ToList()
                });
            }

            return Ok(response);
        }

        // Get: /api/stocks/{id}
        [HttpGet]
        [Route("{id:guid}")]
        public async Task<IActionResult> GetStock([FromRoute]Guid id)
        {
            var stock = await stockRepository.GetAsync(id);
            if (stock == null)
                return NotFound("Stock not found.");

            var response = new StockViewDto();
            foreach(var timeSeries in stock.TimeSeries)
            {
                response.open.Add(timeSeries.Open);
                response.close.Add(timeSeries.Close);
                response.high.Add(timeSeries.High);
                response.low.Add(timeSeries.Low);
                response.openDate.Add(timeSeries.TimeStamp);
            }
            return Ok(response);
        }
    }
}
